const mysql = require('mysql');
const express = require ('express')
const app = express()
const bodyParser= require('body-parser')
var async = require('asyncawait/async');
var await = require('asyncawait/await');
var Promise = require('bluebird');

app.use(bodyParser.urlencoded({extended:false}))
app.use(express.static(__dirname))

//establish connection 
function establish_connection (){
        return mysql.createConnection({
        host: 'localhost',
        user: 'root',
        password: 'RAF#666666',
        database: 'Covid'
})
}

//request from browser
app.get('/top_authors', (req,res) => {
console.log("Searching top authors...")
const dis='%' + req.query.disease + '%'
console.log(dis);

const Squery = "SELECT authors, COUNT(authors) AS value_occurrence "
 + "FROM Mydata WHERE title LIKE ? or abstract LIKE ? GROUP BY authors "
 + "ORDER BY value_occurrence DESC LIMIT 11"
 
const query2 =  "SELECT title FROM Mydata WHERE authors=? and "
 + "(title LIKE ? or abstract LIKE ?)"
 
const connection = establish_connection();

connection.query(Squery, [dis, dis], (err,rows,fields)).then( Mydata => {
    let loop = Promise.resolve();
    for (const row in Mydata) {
        loop=loop.then(() => connection.query(query2, [author, dis, dis], (error, results)).then(title => Mydata[row].title=title )); 
    }
 
    return  loop.then( () => Mydata );
});


})

//localhost:3003
app.listen(3003, () => {
    console.log("Server is up and listening on 3003...")
})


